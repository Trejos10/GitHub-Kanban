<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width,initial-scale=1,viewport-fit=cover"
    />
    <title>GitHub 多仓实时看板</title>
    <meta name="color-scheme" content="light dark" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
      integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <style>
      :root {
        --gap: 12px;
        --card: #fff;
        --muted: #666;
        --bg: #f6f8fa;
        --border: #e1e4e8;
      }
      :root {
        --radius: 10px;
        --tap: 40px;
      }
      @media (prefers-color-scheme: dark) {
        :root {
          --card: #0d1117;
          --bg: #010409;
          --border: #30363d;
          --muted: #8b949e;
        }
        a {
          color: #58a6ff;
        }
        .github-icon:hover {
          color: #fff;
        } /* Dark mode hover */
      }
      [data-theme="dark"] {
        --card: #0d1117;
        --bg: #010409;
        --border: #30363d;
        --muted: #8b949e;
      }
      [data-theme="dark"] a {
        color: #58a6ff;
      }
      [data-theme="dark"] .github-icon:hover,
      [data-theme="dark"] .theme-toggle:hover {
        color: #fff;
      }
      html,
      body {
        margin: 0;
        background: var(--bg);
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica,
          Arial;
      }
      header {
        position: sticky;
        top: 0;
        background: var(--card);
        border-bottom: 1px solid var(--border);
        padding: calc(10px + env(safe-area-inset-top, 0)) 14px 10px;
        z-index: 2;
        position: relative;
      }
      h1 {
        font-size: clamp(16px, 2.2vw, 20px);
        margin: 0 0 6px;
      }
      main {
        max-width: min(1400px, 100%);
        margin: 14px auto;
        padding: 0 14px;
      }
      .grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--gap);
      }
      @media (max-width: 960px) {
        .grid {
          grid-template-columns: 1fr;
        }
      }
      @media (min-width: 1500px) {
        .grid {
          grid-template-columns: 2fr 1fr;
        }
      } /* 超大屏更合理分栏 */
      .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 12px;
      }
      .muted {
        color: var(--muted);
        font-size: 12px;
      }
      .title {
        font-weight: 600;
      }
      .right {
        margin-left: auto;
      }
      .repo-head {
        display: flex;
        justify-content: space-between;
        gap: 8px;
        align-items: center;
        margin-bottom: 6px;
      }
      .repo-stats {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }
      .chip {
        border: 1px solid var(--border);
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 12px;
        background: #fafbfc;
      }
      @media (prefers-color-scheme: dark) {
        .chip {
          background: #0b1320;
        }
      }
      .feed-item {
        display: grid;
        grid-template-columns: 24px 1fr;
        gap: 10px;
        padding: 10px 0;
        border-bottom: 1px dashed var(--border);
      }
      .feed-item:last-child {
        border-bottom: none;
      }
      .icon {
        font-size: 18px;
        line-height: 24px;
        text-align: center;
      }
      .flex {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
      }
      .small {
        font-size: 12px;
      }
      .mono {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
      }
      a,
      button {
        min-height: var(--tap);
        line-height: 1.2;
      }
      a:focus-visible {
        outline: 2px solid #6aa9ff;
        outline-offset: 2px;
        border-radius: 6px;
      }
      .skeleton {
        background: linear-gradient(
          90deg,
          rgba(0, 0, 0, 0.06),
          rgba(0, 0, 0, 0.12),
          rgba(0, 0, 0, 0.06)
        );
        height: 14px;
        border-radius: 6px;
        animation: sh 1.2s infinite;
      }
      @keyframes sh {
        0% {
          background-position: -200px 0;
        }
        100% {
          background-position: 200px 0;
        }
      }
      @media (prefers-reduced-motion: reduce) {
        .skeleton {
          animation: none;
        }
      }

      /* --- Modified styles for GitHub Icon --- */
      .github-icon {
        position: absolute;
        top: 50%;
        right: 14px;
        transform: translateY(-50%);
        color: var(--muted);
        font-size: 28px; /* Control icon size */
        transition: color 0.2s;
        line-height: 1;
        min-width: var(--tap);
        min-height: var(--tap);
      }
      .github-icon:hover {
        color: #000;
      } /* Light mode hover */
      .theme-toggle {
        position: absolute;
        top: 50%;
        right: 94px;
        transform: translateY(-50%);
        color: var(--muted);
        font-size: 24px;
        transition: color 0.2s;
        cursor: pointer;
        min-width: var(--tap);
        min-height: var(--tap);
        border: none;
        background: none;
      }
      .theme-toggle:hover {
        color: #000;
      }
      @media (prefers-color-scheme: dark) {
        .theme-toggle:hover {
          color: #fff;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <h1>GitHub 多仓实时看板</h1>
      <div class="muted" id="meta">初始化中…</div>
      <a
        href="https://github.com/Trejos10/GitHub-Kanban"
        class="github-icon"
        target="_blank"
        rel="noopener noreferrer"
        aria-label="View on GitHub"
      >
        <i class="fa-brands fa-github"></i>
      </a>
      <button
        class="theme-toggle"
        onclick="toggleTheme()"
        aria-label="切换主题"
      >
        <i class="fa-solid fa-moon" id="theme-icon"></i>
      </button>
      <a
        href="/shit-ranking.html"
        class="github-icon"
        style="right: 54px"
        aria-label="史山排行"
      >
        <i class="fa-brands fa-web-awesome"></i>
      </a>
    </header>
    <main>
      <div class="grid">
        <section class="card">
          <div class="repo-head">
            <div class="title">仓库概览 (按最近活动排序)</div>
            <div class="muted small right" id="summaryTs">—</div>
          </div>
          <div id="reposSummary" class="repo-stats">
            <div class="skeleton" style="width: 100%; height: 60px"></div>
          </div>
        </section>
        <section class="card">
          <div class="repo-head">
            <div class="title">最新动态</div>
            <div class="muted small right" id="feedTs">—</div>
          </div>
          <div id="feed">
            <div class="skeleton" style="width: 100%; height: 120px"></div>
          </div>
          <div class="muted small" style="margin-top: 6px">
            数据源：<code
              >Github Events Api (注意：由于 Github
              官方原因，最新动态可能会有长达 8 小时的延迟，请以官网为主）</code
            >
          </div>
        </section>
      </div>
    </main>
    <script>
      const $ = (s) => document.querySelector(s),
        meta = $("#meta"),
        summaryTs = $("#summaryTs"),
        feedTs = $("#feedTs"),
        summaryEl = $("#reposSummary"),
        feedEl = $("#feed");
      const ICONS = {
        Commit: "📝",
        PushEvent: "⬆️",
        PullRequestEvent: "🔀",
        IssuesEvent: "❗",
        IssueCommentEvent: "💬",
        CreateEvent: "🌱",
        DeleteEvent: "🗑️",
        ReleaseEvent: "🏷️",
        ForkEvent: "🍴",
        WatchEvent: "⭐",
        CommitCommentEvent: "📝",
        MemberEvent: "👥",
        public: "📣",
        default: "📌",
      };
      function timeAgo(ts) {
        const s = Math.floor((Date.now() - new Date(ts).getTime()) / 1000);
        if (s < 60) return `${s}s 前`;
        const m = Math.floor(s / 60);
        if (m < 60) return `${m}m 前`;
        const h = Math.floor(m / 60);
        if (h < 24) return `${h}h 前`;
        return `${Math.floor(h / 24)}d 前`;
      }
      function esc(s) {
        return (s || "").replace(
          /[<>&]/g,
          (t) => ({ "<": "&lt;", ">": "&gt;", "&": "&amp;" }[t])
        );
      }
      async function getJSON(url) {
        const r = await fetch(url, { cache: "no-store" });
        if (!r.ok) throw new Error(url + " " + r.status);
        return r.json();
      }

      function renderSummary(repos) {
        // Sort repos by pushed_at date, descending (most recent first)
        const sortedRepos = repos.sort(
          (a, b) =>
            new Date(b.pushed_at).getTime() - new Date(a.pushed_at).getTime()
        );

        summaryEl.innerHTML = sortedRepos
          .map(
            (r) => `
    <div class="card" style="flex:1 1 240px">
      <div class="repo-head">
        <a class="title" href="${
          r.html_url
        }" target="_blank" rel="noreferrer" title="${esc(r.repo)}">${esc(
              r.displayName
            )}</a>
        <span class="muted small">${timeAgo(r.pushed_at)} 更新</span>
      </div>
      <div class="muted small" style="margin-top:6px">${esc(r.repo)}</div>
      <div class="repo-stats">
        <span class="chip">⭐ ${
          r.stargazers_count
        }</span> <span class="chip">🍴 ${
              r.forks_count
            }</span> <span class="chip">🧵 Open: ${r.open_issues_count}</span>
      </div>
      <div class="muted small" style="margin-top:6px">${esc(
        r.description
      )}</div>
    </div>`
          )
          .join("");
      }

      function renderFeed(items) {
        feedEl.innerHTML = items
          .map((it) => {
            const base = `<div class="feed-item">
  <div class="icon" title="${esc(it.repo)}">${
              ICONS[it.type] || it.icon || ICONS.default
            }</div>
  <div>
    <div class="flex">
      <a class="title" href="${it.url}" target="_blank" rel="noreferrer">${esc(
              it.title
            )}</a>
      <span class="muted small right">${timeAgo(
        it.when
      )}</span><div class="muted small">${esc(
              it.extra || ""
            )}</div> <span class="muted small" title="@${esc(it.repo)}">${esc(
              it.displayName
            )}</span>
    </div>`;
            let statLine = "";
            if (
              it.type === "Commit" &&
              it.stats &&
              (it.stats.additions ||
                it.stats.deletions ||
                it.stats.filesChanged)
            ) {
              statLine = `<div class="mono small" style="margin-top:4px">
        <strong>${
          it.stats.filesChanged ?? 0
        }</strong> files changed; <span style="color: green">+${
                it.stats.additions ?? 0
              }</span> <span style="color: red">-${
                it.stats.deletions ?? 0
              }</span> lines
      </div>`;
            }
            return base + statLine + `</div></div>`;
          })
          .join("");
      }
      async function refresh() {
        try {
          const [sum, feed] = await Promise.all([
            getJSON("/api/summary"),
            getJSON("/api/feed"),
          ]);
          renderSummary(sum.repos || []);
          summaryTs.textContent = new Date().toLocaleString(); // Use local time for UI update time
          renderFeed(feed.items || []);
          feedTs.textContent = new Date().toLocaleString();
          const repoNames = (sum.repos || [])
            .map((r) => r.displayName)
            .join(", ");
          meta.textContent = `监控中：${repoNames}`;
        } catch (e) {
          console.error(e);
          meta.textContent = "加载失败: " + e.message;
        }
      }
      function toggleTheme() {
        const html = document.documentElement;
        const icon = document.getElementById('theme-icon');
        const isDark = html.getAttribute('data-theme') === 'dark';
        
        if (isDark) {
          html.removeAttribute('data-theme');
          icon.className = 'fa-solid fa-moon';
          localStorage.setItem('theme', 'light');
        } else {
          html.setAttribute('data-theme', 'dark');
          icon.className = 'fa-solid fa-sun';
          localStorage.setItem('theme', 'dark');
        }
      }
      
      function initTheme() {
        const saved = localStorage.getItem('theme');
        const icon = document.getElementById('theme-icon');
        if (saved === 'dark' || (!saved && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
          document.documentElement.setAttribute('data-theme', 'dark');
          icon.className = 'fa-solid fa-sun';
        }
      }
      
      (function init() {
        initTheme();
        refresh();
        setInterval(refresh, 15000);
      })();
    </script>
  </body>
</html>
